import { useEffect, useState, useCallback } from 'react';
import { Header, Sidebar } from './components/Layout';
import { ServerList } from './components/ServerList';
import { CustomToolForm } from './components/ToolConfig';
import { useStore, useTools, useServers, useConfig } from './hooks';
import { TooltipProvider } from './components/ui/tooltip';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from './components/ui/dialog';
import { Button } from './components/ui/button';
import { Textarea } from './components/ui/textarea';
import { Label } from './components/ui/label';
import type { CustomTool } from './types';

function App() {
  const { selectedToolId, setSelectedToolId, isLoading, error, setError, addCustomTool } = useStore();
  const { tools, refreshTools } = useTools();
  const { servers, loadAllServers, createServer, editServer, deleteServer, testServer, syncToAllTools } = useServers();
  const { exportConfig, importConfig } = useConfig();

  const [customToolFormOpen, setCustomToolFormOpen] = useState(false);
  const [importDialogOpen, setImportDialogOpen] = useState(false);
  const [exportDialogOpen, setExportDialogOpen] = useState(false);
  const [settingsDialogOpen, setSettingsDialogOpen] = useState(false);
  const [importText, setImportText] = useState('');
  const [importError, setImportError] = useState<string | null>(null);

  // Load servers on mount and when tools change
  useEffect(() => {
    if (tools.length > 0) {
      loadAllServers();
    }
  }, [tools, loadAllServers]);

  const handleRefresh = useCallback(() => {
    refreshTools();
    loadAllServers();
  }, [refreshTools, loadAllServers]);

  const handleImport = () => {
    setImportText('');
    setImportError(null);
    setImportDialogOpen(true);
  };

  const handleExport = () => {
    setExportDialogOpen(true);
  };

  const handleSettings = () => {
    setSettingsDialogOpen(true);
  };

  const handleImportSubmit = async () => {
    const result = importConfig(importText);
    if (result.error) {
      setImportError(result.error);
      return;
    }

    // Add imported servers
    for (const server of result.servers) {
      await createServer(server);
    }

    setImportDialogOpen(false);
    setImportText('');
    setImportError(null);
  };

  const handleAddCustomTool = (tool: CustomTool) => {
    addCustomTool(tool);
    refreshTools();
  };

  const exportedConfig = exportConfig(servers);

  return (
    <TooltipProvider>
      <div className="flex h-screen flex-col bg-background">
        <Header
          onRefresh={handleRefresh}
          onImport={handleImport}
          onExport={handleExport}
          onSettings={handleSettings}
          isLoading={isLoading}
        />

        <div className="flex flex-1 overflow-hidden">
          <Sidebar
            tools={tools}
            selectedToolId={selectedToolId}
            onSelectTool={setSelectedToolId}
            onAddCustomTool={() => setCustomToolFormOpen(true)}
          />

          <main className="flex-1 overflow-hidden">
            <ServerList
              servers={servers}
              tools={tools}
              selectedToolId={selectedToolId}
              onCreateServer={createServer}
              onEditServer={editServer}
              onDeleteServer={deleteServer}
              onTestServer={testServer}
            />
          </main>
        </div>

        {/* Error display */}
        {error && (
          <div className="fixed bottom-4 left-1/2 z-50 -translate-x-1/2 rounded-lg border bg-destructive px-4 py-2 text-destructive-foreground shadow-lg">
            <div className="flex items-center gap-4">
              <span>{error}</span>
              <Button
                variant="ghost"
                size="sm"
                className="text-destructive-foreground hover:text-destructive-foreground"
                onClick={() => setError(null)}
              >
                Dismiss
              </Button>
            </div>
          </div>
        )}

        {/* Custom Tool Form */}
        <CustomToolForm
          open={customToolFormOpen}
          onOpenChange={setCustomToolFormOpen}
          onSubmit={handleAddCustomTool}
        />

        {/* Import Dialog */}
        <Dialog open={importDialogOpen} onOpenChange={setImportDialogOpen}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle>Import Configuration</DialogTitle>
              <DialogDescription>
                Paste a previously exported OneMCP configuration to import servers.
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4">
              <div className="space-y-2">
                <Label>Configuration JSON</Label>
                <Textarea
                  value={importText}
                  onChange={(e) => setImportText(e.target.value)}
                  placeholder='{"version": "1.0", "servers": [...]}'
                  className="min-h-[300px] font-mono text-sm"
                />
                {importError && (
                  <p className="text-sm text-destructive">{importError}</p>
                )}
              </div>
            </div>

            <DialogFooter>
              <Button variant="outline" onClick={() => setImportDialogOpen(false)}>
                Cancel
              </Button>
              <Button onClick={handleImportSubmit} disabled={!importText.trim()}>
                Import
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* Export Dialog */}
        <Dialog open={exportDialogOpen} onOpenChange={setExportDialogOpen}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle>Export Configuration</DialogTitle>
              <DialogDescription>
                Copy this configuration to backup or share your MCP server setup.
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4">
              <div className="space-y-2">
                <Label>Configuration JSON</Label>
                <Textarea
                  value={exportedConfig}
                  readOnly
                  className="min-h-[300px] font-mono text-sm"
                />
              </div>
            </div>

            <DialogFooter>
              <Button variant="outline" onClick={() => setExportDialogOpen(false)}>
                Close
              </Button>
              <Button
                onClick={async () => {
                  await navigator.clipboard.writeText(exportedConfig);
                }}
              >
                Copy to Clipboard
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* Settings Dialog */}
        <Dialog open={settingsDialogOpen} onOpenChange={setSettingsDialogOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Settings</DialogTitle>
              <DialogDescription>
                Configure OneMCP preferences.
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-6 py-4">
              <div className="space-y-4">
                <h3 className="text-sm font-medium">Sync</h3>
                <Button onClick={syncToAllTools} className="w-full">
                  Sync All Servers to All Tools
                </Button>
                <p className="text-xs text-muted-foreground">
                  This will update all tool configuration files with the current server list.
                </p>
              </div>

              <div className="space-y-4">
                <h3 className="text-sm font-medium">Tool Paths</h3>
                <div className="space-y-2 text-sm">
                  {tools.map((tool) => (
                    <div key={tool.id} className="flex items-center justify-between">
                      <span>{tool.name}</span>
                      <code className="text-xs text-muted-foreground truncate max-w-[300px]">
                        {tool.configPath}
                      </code>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            <DialogFooter>
              <Button variant="outline" onClick={() => setSettingsDialogOpen(false)}>
                Close
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </TooltipProvider>
  );
}

export default App;
